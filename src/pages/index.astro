---
import Layout from '../layouts/Layout.astro';
import Biography from '../components/Biography.astro';
import Experience from '../components/Experience.astro';
import BlogPostsSection from '../components/BlogPostsSection';
import PublicationCard from '../components/PublicationCard.astro';
import ViewAsMarkdown from '../components/ViewAsMarkdown';
import { getCollection } from 'astro:content';
import { PUBLICATIONS } from '../data/publications';
import { SITE } from '../data/site';
import { generateHomePageMarkdown } from '../utils/markdown-generator';
import {
  generateCollectionPageSchema,
  generateDetailedPersonSchema,
} from '../utils/schema';
import { calculateReadingTime } from '../utils/reading-time';
import { readBlogPostFile, extractMarkdownContent } from '../utils/content-reader';

const blogPosts = (await getCollection('blog')).sort(
  (a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime()
);

// Calculate reading time for each blog post
const blogPostsWithReadingTime = await Promise.all(
  blogPosts.map(async (post) => {
    try {
      const fileContent = await readBlogPostFile(post.id);
      const markdownContent = extractMarkdownContent(fileContent);
      const readingTime = calculateReadingTime(markdownContent);
      return { post, readingTime };
    } catch (error) {
      // If we can't read the file, skip reading time
      return { post, readingTime: undefined };
    }
  })
);

// Transform posts for BlogPostsSection component
const postsForComponent = blogPostsWithReadingTime.map(({ post, readingTime }) => ({
  id: post.id,
  title: post.data.title,
  description: post.data.description,
  pubDate: post.data.pubDate.toISOString(),
  slug: post.id,
  image: post.data.image,
  tags: post.data.tags,
  readingTime,
}));

const homePageMarkdown = generateHomePageMarkdown(blogPosts);
const collectionPageSchema = generateCollectionPageSchema();
const detailedPersonSchema = generateDetailedPersonSchema();
---

<Layout 
  title="Daniel Fridljand - Software Consultant"
  description={SITE.description}
  url={SITE.url}
>
  {/* AI discoverability: JSON-LD structured data for CollectionPage */}
  <script type="application/ld+json" set:html={JSON.stringify(collectionPageSchema)} />
  
  {/* AI discoverability: JSON-LD structured data for detailed Person information */}
  <script type="application/ld+json" set:html={JSON.stringify(detailedPersonSchema)} />
  <section
    id="home"
    class="min-h-screen flex items-center justify-center bg-gradient-to-br from-[#004ba0] to-[#1976d2] text-white scroll-mt-20"
  >
    <div class="container mx-auto px-4 text-center">
      <h1 class="text-5xl md:text-6xl font-bold mb-4">Daniel Fridljand</h1>
      <p class="text-2xl md:text-3xl mb-8">Software Consultant</p>
      <p class="text-xl opacity-90">TNG Technology Consulting</p>
    </div>
  </section>

  <Biography markdownHref="/index.md" />

  <section id="posts" class="py-16 bg-surface scroll-mt-20">
    <div class="container mx-auto px-4">
      <BlogPostsSection posts={postsForComponent} client:load />
    </div>
  </section>

  <Experience />

  <section id="publications" class="py-16 bg-surface-alt scroll-mt-20">
    <div class="container mx-auto px-4">
      <div class="max-w-4xl mx-auto">
        <h2 class="text-3xl font-bold mb-8 text-heading text-mobile-center">
          <a href="#publications" class="heading-link">Publications</a>
        </h2>
        <div class="space-y-6">
          {PUBLICATIONS.map((pub) => (
            <PublicationCard publication={pub} />
          ))}
        </div>
      </div>
    </div>
  </section>
</Layout>
