services:
  # Langflow Web Service
  - type: web
    name: langflow
    runtime: docker
    dockerfilePath: ./dynamic/langflow-workspace/Dockerfile
    dockerContext: ./dynamic/langflow-workspace
    plan: starter  # Start with free plan; upgrade to standard if Langflow needs more RAM (2GB+)
    region: frankfurt  # European region
    envVars:
      # Database connection - will be set automatically by Render
      - key: LANGFLOW_DATABASE_URL
        fromDatabase:
          name: langflow-db
          property: connectionString
      # Configuration directory
      - key: LANGFLOW_CONFIG_DIR
        value: /app/langflow
      # Authentication - enable for production (set via Render dashboard)
      # Set to "true" for development/testing, "false" for production
      - key: LANGFLOW_SKIP_AUTH_AUTO_LOGIN
        value: "false"
      # Environment variable handling
      - key: LANGFLOW_STORE_ENVIRONMENT_VARIABLES
        value: "true"
      - key: LANGFLOW_VARIABLES_TO_GET_FROM_ENVIRONMENT
        value: GOOGLE_AI_STUDIO_API_KEY,ASTRA_DB_API_KEY
      # Port configuration - LANGFLOW_PORT is automatically set in entrypoint.sh to match Render's PORT
      # This ensures Langflow binds to the port that Render expects (default 10000)
      # Host configuration - explicitly set to 0.0.0.0 for Render port detection
      - key: LANGFLOW_HOST
        value: "0.0.0.0"
      # API keys - set these in Render dashboard
      - key: GOOGLE_AI_STUDIO_API_KEY
        sync: false
      - key: ASTRA_DB_API_KEY
        sync: false
      # Opt out of anonymous usage data collection
      - key: DO_NOT_TRACK
        value: "true"
    # Health check path - allows Render to monitor service health and auto-restart if needed
    # Langflow provides /health_check endpoint that validates database and chat service connectivity
    healthCheckPath: /health_check
    # Copy content files into the Docker build context before building
    # This ensures files are available during Docker build
    # Note: buildCommand runs from repo root, dockerContext is ./dynamic/langflow-workspace
    buildCommand: |
      # Ensure we're in the repo root and create content directory in docker context
      mkdir -p dynamic/langflow-workspace/content
      # Copy files if they exist (using || true to prevent build failure)
      [ -f content/_index.md ] && cp content/_index.md dynamic/langflow-workspace/content/repository-homepage.md || touch dynamic/langflow-workspace/content/repository-homepage.md
      [ -f content/authors/admin/_index.md ] && cp content/authors/admin/_index.md dynamic/langflow-workspace/content/author-information.md || touch dynamic/langflow-workspace/content/author-information.md
      [ -f public/uploads/resume.pdf ] && cp public/uploads/resume.pdf dynamic/langflow-workspace/content/resume.pdf || touch dynamic/langflow-workspace/content/resume.pdf
      [ -d assets/media/icons/brands ] && cp -r assets/media/icons/brands dynamic/langflow-workspace/content/brand-icons || mkdir -p dynamic/langflow-workspace/content/brand-icons
      [ -f content/publication/preprint/cite.bib ] && cp content/publication/preprint/cite.bib dynamic/langflow-workspace/content/publication-preprint-cite.bib || touch dynamic/langflow-workspace/content/publication-preprint-cite.bib
      [ -f content/publication/preprint/index.md ] && cp content/publication/preprint/index.md dynamic/langflow-workspace/content/publication-preprint.md || touch dynamic/langflow-workspace/content/publication-preprint.md

  # Astro Static Site
  - type: web
    name: astro-site
    runtime: static
    branch: clean-start-2
    buildCommand: npm run build
    staticPublishPath: dist
    envVars:
      # Langflow URL - REQUIRED: Set this to your deployed Langflow service URL
      # After deploying, get the URL from the Langflow service dashboard (e.g., https://langflow-xxxxx.onrender.com)
      # and set it in the Render dashboard for this astro-site service
      - key: PUBLIC_LANGFLOW_URL
        sync: false
      # Flow ID - Set after first Langflow deployment
      # After Langflow service starts, check the logs for "Flow 'Document Q&A' imported successfully with ID: ..."
      # Copy that ID and set it here, or check /app/content/flow-id.txt in the Langflow container
      # The chat widget will use this ID to connect to the correct flow
      - key: PUBLIC_LANGFLOW_FLOW_ID
        sync: false

# Postgres Database
databases:
  - name: langflow-db
    plan: free  # Free tier; can upgrade if needed
    region: frankfurt  # European region - must match Langflow service region
    databaseName: langflow
    user: langflow
